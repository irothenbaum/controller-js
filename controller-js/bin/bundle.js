!function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=5)}([function(e,t){e.exports=class{constructor(){this.__observers=[],this.__counter=0,this.on.bind(this),this.off.bind(this),this.trigger.bind(this)}trigger(e,t=null){let s=[];for(let n=0;n<this.__observers.length;n++){let r=this.__observers[n];("string"==typeof r.match&&r.match===e||r.match instanceof RegExp&&r.match.test(e))&&(r.isOnce&&s.push(r.id),r.handler(t,e))}s.length>0&&s.forEach(e=>{this.off(e)})}on(e,t,s=!1){let n=++this.__counter;return this.__observers.push({id:n,match:e,handler:t,isOnce:s}),n}off(e){return"number"==typeof e?this.__offByProp(e,"id"):"function"==typeof e&&this.__offByProp(e,"handler")}_clearObservables(){this.__observers=[]}__offByProp(e,t){let s=!1;if(this.__observers.every((n,r)=>n[t]!==e||(s=r,!1)),!1!==s){return this.__observers.splice(s,1).handler}return!1}}},function(e,t,s){const n=s(3),r=s(8),i=s(4);e.exports={Types:n,Event:i,ButtonPressEvent:r}},function(e,t,s){function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const r=s(0);class i extends r{constructor(e){super(),this.send=this.send.bind(this),this.__missedHeartbeats=0,this.__queue=[],this.__socket=new WebSocket(e),this.__socket.onopen=this.init.bind(this),this.__socket.onmessage=this.__handleSocketMessage.bind(this)}init(){this.startHeartbeat(1e3)}startHeartbeat(e){this.__heartbeatInterval&&clearInterval(this.__heartbeatInterval),this.__heartbeatInterval=setInterval(()=>{try{if(this.__missedHeartbeats++,this.__missedHeartbeats>=3)throw new a("3 missed heartbeats");this.send(i.TYPE_HEARTBEAT)}catch(e){this.trigger(i.EVENT_CONNECTION_ERROR,e),this.close()}},e)}send(e,t){return 1!==this.__socket.readyState?(this.__queue.push(arguments),this.__startQueue(),!1):this.__sendInternal(e,t)}__handleSocketMessage({data:e}){let t=o.fromReceived(e);this.trigger(i.EVENT_MESSAGE_RECEIVED,t)}__sendInternal(e,t){let s=o.toSend(e,t);this.__socket.send(JSON.stringify(s)),this.trigger(i.EVENT_MESSAGE_SENT,s)}__startQueue(){this.__queueInterval||(this.__queueInterval=setInterval(()=>{if(1===this.__socket.readyState&&(clearInterval(this.__queueInterval),delete this.__queueInterval,this.trigger(i.EVENT_CONNECTION_OPENED),this.__queue.length>0)){do{let e=this.__queue.shift();this.send(e[0],e[1])}while(this.__queue.length>0&&1===this.__socket.readyState);1!==this.__socket.readyState&&this.__queue.length>0&&this.__startQueue()}},50))}close(){clearInterval(this.__heartbeatInterval),delete this.__heartbeatInterval,clearInterval(this.__queueInterval),delete this.__queueInterval,this.__socket.close(),this.trigger(i.EVENT_CONNECTION_CLOSED)}}n(i,"EVENT_MESSAGE_SENT","message-sent"),n(i,"EVENT_MESSAGE_RECEIVED","message-received"),n(i,"EVENT_CONNECTION_OPENED","connection-opened"),n(i,"EVENT_CONNECTION_CLOSED","connection-closed"),n(i,"EVENT_CONNECTION_ERROR","connection-error"),n(i,"TYPE_HEARTBEAT","heartbeat");class o{constructor(){n(this,"type",void 0),n(this,"timestamp_sent",void 0),n(this,"timestamp_received",void 0),n(this,"payload",void 0)}static toSend(e,t){let s=new o;return s.type=e,s.payload=t,s.timestamp_sent=Date.now(),s}static fromReceived(e){let t=JSON.parse(e),s=new o;return s.type=t.type,s.payload=t.payload,s.timestamp_sent=t.timestamp_sent,s.timestamp_received=Date.now(),s}}class a extends Error{}i.HeartbeatConnectionError=a,i.DataMessage=o,e.exports=i},function(e,t){e.exports={GAME:{JOYSTICK:{MOVE:"game:joystick:move",MOVE_START:"game:joystick:move-start",MOVE_STOP:"game:joystick:move-stop"},BUTTON:{PRESS:"game:button:press",PRESS_DOWN:"game:button:press-down",PRESS_UP:"game:button:press-up"}},CONNECTION:{INIT:"connection:init",READY:"connection:ready",WAITING:"connection:waiting",CLOSE:"connection:close"}}},function(e,t){function s(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}e.exports=class{constructor(e){s(this,"type",void 0),s(this,"timestamp",void 0),this.type=e,this.timestamp=Date.now()}}},function(e,t,s){e.exports=s(6)},function(e,t,s){const n=s(7),r=s(9),i=s(1);e.exports={GameConnector:n,ControllerConnector:r,EVENTS:i}},function(e,t,s){const n=s(2),r=s(0),{Types:i,Event:o,ButtonPressEvent:a}=s(1),{DataMessage:c,HeartbeatConnectionError:_}=n;e.exports=class extends r{constructor(){super()}async init(e,t){this.close(),this.__connection=new n(e),this.__connection.on(n.EVENT_MESSAGE_RECEIVED,this.__handleDataMessage),this.__connection.send(i.CONNECTION.REQUEST,{code:t}),this.trigger(i.CONNECTION.REQUEST)}async close(){this.__connection&&(this.__connection.close(),this.trigger(i.CONNECTION.CLOSE))}__handleDataMessage(e){let t;switch(e.type){case i.GAME.BUTTON.PRESS:t=a(e.payload.code),t.timestamp=e.payload.timestamp;break;default:throw new Error("Unrecognized Event Type")}this.trigger(e.type,t)}}},function(e,t,s){const n=s(4),r=s(3);e.exports=class extends n{constructor(e){var t,s,n;super(r.GAME.BUTTON.PRESS),n=void 0,(s="code")in(t=this)?Object.defineProperty(t,s,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[s]=n,this.code=e}}},function(e,t,s){const n=s(2),r=s(0),{Types:i,ButtonPressEvent:o}=s(1);e.exports=class extends r{constructor(){super()}async init(e,t){this.close(),this.__connection=new n(e),this.__connection.init(),this.__connection.send(i.CONNECTION.INIT,{code:t}),this.trigger(i.CONNECTION.INIT)}async close(){this.__connection&&(this.__connection.close(),this.trigger(i.CONNECTION.CLOSE))}sendButtonPressDown(){}sendButtonPress(e){let t=new o(e);this.__connection.send(i.GAME.BUTTON.PRESS_UP,t)}sendButtonPressUp(){}sendJoystickMoveStart(){}sendJoystickMoveStop(){}sendJoystickMove(){}}}]);
//# sourceMappingURL=bundle.js.map